<section class="bg-emerald-50/60 min-h-[80vh]" *ngIf="q() as x">
  <div class="mx-auto max-w-5xl px-6 py-8">

    <!-- Header -->
    <div class="mb-6 flex flex-wrap items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <h1 class="text-3xl font-extrabold text-gray-900">Cotización #{{ x.id }}</h1>
        <!-- status badge -->
        <span class="rounded-full border border-gray-200 bg-white/80 px-3 py-1 text-xs font-semibold text-gray-700">
          {{ x.status }}
        </span>
      </div>

      <button
        class="inline-flex items-center justify-center rounded-xl bg-emerald-700 px-4 py-2 font-semibold text-white shadow-md transition hover:scale-[1.01] hover:bg-emerald-600 active:scale-95"
        (click)="sendEmail()">
        Enviar por correo
      </button>
    </div>

    <!-- LÍNEAS (tabla en tarjeta) -->
    <div class="overflow-hidden rounded-2xl border bg-white/80 backdrop-blur shadow ring-1 ring-black/5">
      <table class="w-full table-auto text-sm text-gray-700">
        <thead class="bg-gray-50/80 text-gray-600">
          <tr>
            <th class="p-3 text-left font-semibold">Producto</th>
            <th class="p-3 text-right font-semibold">Cant.</th>
            <th class="p-3 text-right font-semibold">Precio</th>
            <th class="p-3 text-right font-semibold">Total</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let l of x.lines; trackBy: trackLine" class="border-t">
            <td class="p-3">{{ l.name }}</td>
            <td class="p-3 text-right">{{ l.quantity }}</td>
            <td class="p-3 text-right">{{ l.unitPrice | currency }}</td>
            <td class="p-3 text-right font-medium">{{ l.lineTotal | currency }}</td>
          </tr>
        </tbody>
        <tfoot>
          <tr class="border-t bg-gray-50/60">
            <td colspan="3" class="p-3 text-right font-semibold">Subtotal productos</td>
            <td class="p-3 text-right font-semibold">{{ x.productsSubtotal | currency }}</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Estado corto -->
    <p class="mt-3 text-sm text-gray-600">
      Estado: <span class="font-semibold text-gray-800">{{ x.status }}</span>
    </p>

    <!-- OPCIONES -->
    <div class="mt-6 rounded-2xl border bg-white/80 backdrop-blur p-5 shadow ring-1 ring-black/5">
      <h2 class="mb-4 text-lg font-semibold text-gray-800">Opciones de cumplimiento</h2>

      <form [formGroup]="form" class="space-y-4">
        <!-- Radios (Flowbite style) -->
        <div class="flex flex-wrap gap-x-8 gap-y-2">
          <label class="inline-flex items-center gap-2 text-sm text-gray-700">
            <input type="radio" class="text-emerald-600 focus:ring-emerald-500"
                   formControlName="fulfillment" value="DevicesOnly" />
            Solo productos
          </label>
          <label class="inline-flex items-center gap-2 text-sm text-gray-700">
            <input type="radio" class="text-emerald-600 focus:ring-emerald-500"
                   formControlName="fulfillment" value="Shipping" />
            Envío a domicilio
          </label>
          <label class="inline-flex items-center gap-2 text-sm text-gray-700">
            <input type="radio" class="text-emerald-600 focus:ring-emerald-500"
                   formControlName="fulfillment" value="Installation" />
            Instalación
          </label>
        </div>

        <!-- Campos que requieren estado -->
        <div class="grid gap-4 md:grid-cols-3" *ngIf="needsState()">
          <div>
            <label class="mb-1 block text-sm text-gray-600">Estado</label>
            <select formControlName="stateCode"
                    class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
              <option [ngValue]="null">Seleccione…</option>
              <option *ngFor="let s of states()" [value]="s.stateCode">{{ s.stateName }}</option>
            </select>
          </div>

          <div>
            <label class="mb-1 block text-sm text-gray-600">Distancia (km) (opcional)</label>
            <input type="number" min="0" formControlName="manualDistanceKm"
                   class="w-full rounded-xl border border-gray-300 bg-white px-3 py-2 text-gray-900 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />
            <p class="mt-1 text-xs text-gray-500">En Guanajuato el envío/transporte es $0.</p>
          </div>

          <div class="flex items-end">
            <button type="button"
              class="inline-flex items-center justify-center rounded-xl bg-emerald-700 px-4 py-2 font-semibold text-white shadow-md transition hover:scale-[1.01] hover:bg-emerald-600 active:scale-95 disabled:opacity-50"
              (click)="save()"
              [disabled]="saving() || (needsState() && !form.value.stateCode)">
              {{ saving() ? 'Guardando…' : 'Guardar opciones' }}
            </button>
          </div>
        </div>
      </form>

      <!-- PREVIEW -->
      <div class="mt-5" *ngIf="preview() as p">
        <h3 class="mb-3 text-base font-semibold text-gray-800">Desglose estimado</h3>

        <div class="grid gap-3 sm:grid-cols-2">
          <div class="flex items-center justify-between rounded-xl border bg-white/70 px-3 py-2 text-sm shadow-sm">
            <span class="text-gray-700">Productos</span>
            <b>{{ p.products | currency }}</b>
          </div>
          <div class="flex items-center justify-between rounded-xl border bg-white/70 px-3 py-2 text-sm shadow-sm">
            <span class="text-gray-700">Instalación (base)</span>
            <b>{{ p.installBase | currency }}</b>
          </div>
          <div class="flex items-center justify-between rounded-xl border bg-white/70 px-3 py-2 text-sm shadow-sm">
            <span class="text-gray-700">Transporte</span>
            <b>{{ p.transport | currency }}</b>
          </div>
          <div class="flex items-center justify-between rounded-xl border bg-white/70 px-3 py-2 text-sm shadow-sm">
            <span class="text-gray-700">Envío</span>
            <b>{{ p.shipping | currency }}</b>
          </div>
          <div class="sm:col-span-2 flex items-center justify-between rounded-xl border bg-emerald-50 px-3 py-2 text-sm shadow-sm">
            <span class="font-semibold text-gray-800">Total</span>
            <b class="text-gray-900">{{ (preview()?.grandTotal ?? x.grandTotal) | currency }}</b>
          </div>
        </div>

        <div *ngIf="loadingPreview()" class="mt-2 text-sm text-gray-500">Calculando…</div>
      </div>
    </div>

    <!-- Mensaje global -->
    <p *ngIf="msg()" class="mt-3 text-sm"
       [class.text-green-700]="ok()" [class.text-red-700]="!ok()">
      {{ msg() }}
    </p>
  </div>
</section>
